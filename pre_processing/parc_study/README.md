# Micapipe Parcellation Report

**Author:** Chris Norman

**Contact:** NormanC4@cardiff.ac.uk

**micapipe version:** 0.1.2

The micapipe proc_rsfmri pipeline generates timeseries (TS) and functional connectivity (FC) matrices for a range of parcellations and surface meshes. The dimensions of these matrices are sometimes unexpected, sometimes in contradiction with each other, and seemingly unjustified in [the micapipe documentation](https://micapipe.readthedocs.io/en/latest/pages/01.whatyouneed/index.html).

This report provides a brief explanation of how parcellated functional activity matrices are generated by the pipeline, the reasons for apparent inconsistencies and suggestions for how to handle them. It is mainly informed by [the source code](https://github.com/MICA-MNI/micapipe), with parts verified using the accompanying files.

Note: this investigation only concerned micapipe's [output functional activity matrices](https://micapipe.readthedocs.io/en/latest/pages/04.matrices/index.html#resting-state-functional-connectome), FC and TS. If similar issues exist within structural outputs they were not investigated. As of this version FC matrices are generated for each subject in their native space (fsnative) and also the averaged conte69-32k space (Glasser and van Essen, 2011), whereas TS matrices are only stored in fsnative space. [Parcellations available in micapipe](https://micapipe.readthedocs.io/en/latest/pages/02.structuralproc/index.html#post-structural) are:
* aparc-a2009s
* aparc
* economo
* glasser-360 (HCP-MMP1)
* schaefer-1000
* schaefer-100
* schaefer-200
* schaefer-300
* schaefer-400
* schaefer-500
* schaefer-600
* schaefer-700
* schaefer-800
* schaefer-900
* vosdewael-100
* vosdewael-200
* vosdewael-300
* vosdewael-400

## Non-cortical parcellations

Parcellated FC and TS matrices saved by micapipe are concatenations of subcortical, cerebellar, and parcellated cortical ROIs. Subcortex and cerebellum data are read from a subject's volumetric directory. The subcortex always contains 14 ROIs, the cerebellum is intended to have 34, however 'co-registration to fMRI space (may) make some cerebellar ROIs disappear' ([03_FC.py](https://github.com/MICA-MNI/micapipe/blob/master/functions/03_FC.py)). In this case one or more columns of zeroes is added in place of the missing ROIs to bring the total cerebellum size back up to 34.

**Note:** If cerebellar ROIs are missing when volumetric data is loaded in [03_FC.py](https://github.com/MICA-MNI/micapipe/blob/master/functions/03_FC.py) then a bug is triggered which results in all output cerebellar regions taking integer values.

In any case, subcortical and cerebellar regions can be removed from stored FC and TS matrices by removing the **first** 48 ROIs. i.e. remove the first 48 columns from TS matrices, and the first 48 columns and rows from FC matrices.

## Inconsistent numbers of cortical parcellations

Once the non-cortical ROIs have been removed, the remaining matrices constitute the functional activity of the cortex. However, the number of ROIs in a given matrix in sometimes not equal to the expected number of parcellations in the corresponding atlas, as in these two examples which are true for all subjects in the ALSPAC dataset.
* The cortical TS matrix corresponding to the **glasser-360 atlas** in **fsnative space** has **362 columns**.
* The cortical TS matrix corresponding to the **glasser-360 atlas** in **conte69 space** has **361 columns**.
Both behaviours are the result of vertex labelling, although a separate explanation of is required for each space.

### fsnative

For fsnative space, labels for each subject are read from annotation files found at (PARENT_DIR)/freesurfer/(SUBJECT)/label/. These labels include a 'medial wall' / 'background' / 'unknown' region, in addition to the expected cortical regions in that atlas, an expected behaviour from freesurfer. There is one of these regions per hemisphere, hence for almost all atlases there are two additional ROIs in FC and TS matrices above the expected number of cortical parcellations.

The only exceptions to the above are *aparc-a2009s* and *economo* atlases. In these cases we find that ROIs 1 ('medialwall') and 2 ('unknown') for each respectively are not referenced to any surface vertex by the labelling in the corresponding .annot files. Regions not referenced to any surface vertex are ignored by micapipe (see [03_FC.py](https://github.com/MICA-MNI/micapipe/blob/master/functions/03_FC.py)), so in these cases output matrices with a number of ROIs equal to the expected number of parcellations in each atlas.

### conte69

For conte69-32k space, vertex labels for each subject are drawn directly from a list at (MICAPIPE_PATH)/parcellations/. For simplicity, only the HCP_MMP1 atlas, file glasser-360_conte69.csv, is considered here. Given the number of elements this labelling appears to be a concatenation of both hemispheres (left then right one must assume), although it contains 361 unique elements corresponding to distinct ROIs (one would expect an even number, if both hemispheres were combined). The eventual realisation came that, in this list, the background / medial wall ROIs for L and R hemispheres are combined into a single label, '0'. This hypothesis was verified twice (see validate_labels_glasser-360_conte69-32k.py) in the following ways.

Label files for the HCP_MMP atlas were found on the scw1648 server at .../scw1648/Pipeline_codes/SC_calc/plot/HCP:
* HCP_MMP0.L.32k_fs_LR.label.gii
* HCP_MMP0.R.32k_fs_LR.label.gii

These files were previously used to project structural connectivity results onto a brain surface. The L and R hemisphere labels were concatenated, and the indices of this concatenated array corresponding to the left and right medial walls coincide with the indices of the glasser-360_conte69.csv array carrying label '0'.

For further verification the original 32k vertex HCP-MMP1 labellings were downloaded from [the BALSA database](https://balsa.wustl.edu/study/RVVG).
* Q1-Q6_RelatedParcellation210.L.CorticalAreas_dil_Final_Final_Areas_Group.32k_fs_LR.dlabel.nii
* Q1-Q6_RelatedParcellation210.R.CorticalAreas_dil_Final_Final_Areas_Group.32k_fs_LR.dlabel.nii

These were converted to label files with the HCP_workbench command:
* wb_command -cifti-separate Q1-Q6_RelatedParcellation210.L.CorticalAreas_dil_Final_Final_Areas_Group.32k_fs_LR.dlabel.nii COLUMN -label CORTEX_LEFT Q1-Q6_RelatedParcellation210.L.CorticalAreas_dil_Final_Final_Areas_Group.32k_fs_LR.label.gii

(as well as the R hemisphere) according to the [very helpful instructions](https://figshare.com/articles/dataset/HCP-MMP1_0_projected_on_fsaverage/3498446) provided by Prof. Kathryn Mills. The same step above (hemisphere concatenation and comparison with the glasser-360_conte69.csv array) again verified that the L and R medial walls were assigned the same label in the micapipe array.

**Note:** This step revealed that the HCP_MMP atlases used in the structural connectivity study, mentioned above, actually used different 32k vertex labelling files from [the BALSA database](https://balsa.wustl.edu/study/RVVG):
* Q1-Q6_RelatedValidation210.L.CorticalAreas_dil_210P_Orig.32k_fs_LR.dlabel.nii
* Q1-Q6_RelatedValidation210.R.CorticalAreas_dil_210P_Orig.32k_fs_LR.dlabel.nii

Furthermore, neither these 'Orig' labellings nor the 'Final' labellings used above matched the labelling provided by micapipe in glasser-360_conte69.csv. However, the vertices corresponding to background / medial walls are the same between all three labellings.

## References

* Glasser MF, Van Essen DC. Mapping human cortical areas in vivo based on myelin content as revealed by T1- and T2-weighted MRI. J Neurosci. 2011 Aug 10;31(32):11597-616. doi: 10.1523/JNEUROSCI.2180-11.2011.
